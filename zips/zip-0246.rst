::

  ZIP: 246
  Title: Digests for the Version 6 Transaction Format
  Owners: Arya <arya@zfnd.org>
          Conrado Gouvea <conrado@zfnd.org>
          Daira-Emma Hopwood <daira-emma@electriccoin.co>
          Jack Grigg <str4d@electriccoin.co>
          Kris Nuttycombe <kris@electriccoin.co>
  Status: Draft
  Category: Consensus
  Created: 2025-02-12
  License: MIT


===========
Terminology
===========

The key words "MUST" and "MUST NOT" in this document are to be interpreted as described
in BCP 14 [#BCP14]_ when, and only when, they appear in all capitals.

The terms "consensus branch", "epoch", and "network upgrade" in this document are to be
interpreted as described in ZIP 200. [#zip-0200]_

The term "field encoding" refers to the binary serialized form of a Zcash transaction
field, as specified in section 7.1 of the Zcash protocol specification
[#protocol-txnencoding]_.


========
Abstract
========

This ZIP defines the digest algorithms associated with the v6 transaction format.

This proposal also defines the new concept of "sighash versioning": where previously
each transaction version had a single associated digest algorithm, going forward it
will be possible for signers to use any digest algorithm within the closed set
specified for a given transaction version (and made available in consensus via network
upgrades).


==========
Motivation
==========

TBD

TODO: Motivate sighash versioning


============
Requirements
============

- Continue to support existing functionality of the protocol (multisig,
  signing modes for transparent inputs).

- It should be possible to update this ZIP with additional digest versions after the first
  version has been deployed in a network upgrade.


================
Non-requirements
================

TBD


=============
Specification
=============

------------------
Sighash versioning
------------------

Rough summary:

- Sighash versions are numbered starting from 0 for each tx version.
- v0 is by convention the "commit to everything" sighash digest. Other versions can commit to whatever makes sense for desired functionality within that tx version.
- Have a single byte encoded alongside the signature (not appended the way transparent does) that permits the signer to specify which sighash version they are using.
- Consensus rules choose the digest algorithm for each signer based on that byte.

----------
v0 Digests
----------

TBD


TxId Digest
===========

The transaction digest algorithm defined in ZIP 244 [#zip-0244]_ is modified by the OrchardZSA protocol to add a new branch for issuance information, along with replacement of the ``orchard_digest`` with a new ``orchard_zsa_digest`` to account for the inclusion of the Asset Base and the updated transaction format.
The details of these changes are described in this section, and highlighted using the ``[ADDED FOR ZSA]`` text label. We omit the details of the sections that do not change for the OrchardZSA protocol.

txid_digest
-----------
A BLAKE2b-256 hash of the following values::

   T.1: header_digest       (32-byte hash output)
   T.2: transparent_digest  (32-byte hash output)
   T.3: sapling_digest      (32-byte hash output)
   T.4: orchard_zsa_digest  (32-byte hash output)  [ADDED FOR ZSA]
   T.5: issuance_digest     (32-byte hash output)  [ADDED FOR ZSA]

The personalization field remains the same as in ZIP 244 [#zip-0244]_.

T.4: orchard_zsa_digest
```````````````````````
When OrchardZSA Actions Groups are present in the transaction, this digest is a BLAKE2b-256 hash of the following values::

    T.4a: orchard_zsa_action_groups_digest   (32-byte hash output)
    T.4b: orchard_zsa_burn_digest            (32-byte hash output)
    T.4b: valueBalanceOrchard                (64-bit signed little-endian)

The personalization field of this hash is the same as for ``orchard_digest`` in ZIP 244 [#zip-0244]_ ::

    "ZTxIdOrchardHash"

In the case that the transaction has no OrchardZSA Action Groups, ``orchard_zsa_digest`` is ::

    BLAKE2b-256("ZTxIdOrchardHash", [])

T.4a: orchard_zsa_action_groups_digest
''''''''''''''''''''''''''''''''''''''

A BLAKE2b-256 hash of the subset of OrchardZSA Action Groups information for all OrchardZSA Action Groups belonging to the transaction.
For each Action Group, the following elements are included in the hash::

    T.4a.i   : orchard_zsa_actions_compact_digest      (32-byte hash output)
    T.4a.ii  : orchard_zsa_actions_memos_digest        (32-byte hash output)
    T.4a.iii : orchard_zsa_actions_noncompact_digest   (32-byte hash output)
    T.4a.iv  : flagsOrchard                            (1 byte)
    T.4a.v   : anchorOrchard                           (32 bytes)
    T.4a.vi  : nAGExpiryHeight                         (4 bytes)

The personalization field of this hash is set to::

    "ZTxIdOrcActGHash"


T.4a.i: orchard_zsa_actions_compact_digest
..........................................

A BLAKE2b-256 hash of the subset of OrchardZSA Action information intended to be included in
an updated version of the ZIP-307 [#zip-0307]_ ``CompactBlock`` format for all OrchardZSA
Actions belonging to the Action Group. For each Action, the following elements are included
in the hash::

   T.4a.i.1 : nullifier            (field encoding bytes)
   T.4a.i.2 : cmx                  (field encoding bytes)
   T.4a.i.3 : ephemeralKey         (field encoding bytes)
   T.4a.i.4 : encCiphertext[..84]  (First 84 bytes of field encoding)

The personalization field of this hash is the same as for ``orchard_actions_compact_digest`` in ZIP 244::

  "ZTxIdOrcActCHash"


T.4a.ii: orchard_zsa_actions_memos_digest
.........................................

A BLAKE2b-256 hash of the subset of Orchard shielded memo field data for all OrchardZSA
Actions belonging to the Action Group. For each Action, the following elements are included
in the hash::

    T.4a.ii.1: encCiphertext[84..596] (contents of the encrypted memo field)  

The personalization field of this hash is identical to that for ``orchard_actions_memos_digest`` in ZIP 244::

  "ZTxIdOrcActMHash"


T.4a.iii: orchard_zsa_actions_noncompact_digest
...............................................

A BLAKE2b-256 hash of the remaining subset of OrchardZSA Action information **not** intended
for inclusion in an updated version of the the ZIP 307 [#zip-0307]_ ``CompactBlock``
format, for all OrchardZSA Actions belonging to the Action Group. For each Action,
the following elements are included in the hash::

   T.4a.iii.1 : cv                    (field encoding bytes)
   T.4a.iii.2 : rk                    (field encoding bytes)
   T.4a.iii.3 : encCiphertext[596..]  (post-memo suffix of field encoding)
   T.4a.iii.4 : outCiphertext         (field encoding bytes)

The personalization field of this hash is defined just as for ``orchard_actions_noncompact_digest`` in ZIP 244::

    "ZTxIdOrcActNHash"


T.4b: orchard_zsa_burn_digest
'''''''''''''''''''''''''''''

A BLAKE2b-256 hash of the data from the burn fields of the transaction. For each tuple in 
the $\mathsf{assetBurn}$ set, the following elements are included in the hash::

    T.4b.i : assetBase    (field encoding bytes)
    T.4b.ii: valueBurn    (field encoding bytes)

The personalization field of this hash is set to::

    "ZTxIdOrcBurnHash"

In case the transaction does not perform the burning of any Assets (i.e. the 
$\mathsf{assetBurn}$ set is empty), the ``orchard_zsa_burn_digest`` is::

    BLAKE2b-256("ZTxIdOrcBurnHash", [])

T.4b.i: assetBase
.................
The Asset Base being burnt encoded as the 32-byte representation of a point on the 
Pallas curve.

T.4b.ii: valueBurn
..................
Value of the Asset Base being burnt encoded as little-endian 8-byte representation 
of 64-bit unsigned integer (e.g. u64 in Rust) raw value.


T.5: issuance_digest
````````````````````
The details of the computation of this value are in ZIP 227 [#zip-0227-txiddigest]_.


Signature Digest
================

The per-input transaction digest algorithm to generate the signature digest in ZIP 244 [#zip-0244-sigdigest]_ is modified so that a signature digest is produced for each transparent input, each Sapling input, each OrchardZSA Action, and additionally for each Issuance Action.
The modifications replace the ``orchard_digest`` in ZIP 244 with a new ``orchard_zsa_digest``, and add a new branch, ``issuance_digest``, for the Issuance Action information.

The overall structure of the hash is as follows. We highlight the changes for the OrchardZSA protocol via the ``[ADDED FOR ZSA]`` text label, and we omit the descriptions of the sections that do not change for the OrchardZSA protocol::

    signature_digest
    ├── header_digest
    ├── transparent_sig_digest
    ├── sapling_digest
    ├── orchard_zsa_digest      [ADDED FOR ZSA]
    └── issuance_digest         [ADDED FOR ZSA]

signature_digest
----------------
A BLAKE2b-256 hash of the following values ::

   S.1: header_digest          (32-byte hash output)
   S.2: transparent_sig_digest (32-byte hash output)
   S.3: sapling_digest         (32-byte hash output)
   S.4: orchard_zsa_digest     (32-byte hash output)  [ADDED FOR ZSA]
   S.5: issuance_digest        (32-byte hash output)  [ADDED FOR ZSA]

The personalization field remains the same as in ZIP 244 [#zip-0244]_, namely::

  "ZcashTxHash_" || CONSENSUS_BRANCH_ID

``ZcashTxHash_`` has 1 underscore character.

S.4: orchard_zsa_digest
```````````````````````
Identical to that specified for the transaction identifier.

S.5: issuance_digest
````````````````````
Identical to the ``issuance_digest`` specified for the transaction identifier in ZIP 227 [zip-0227-txiddigest]_.


Authorizing Data Commitment
===========================

The transaction digest algorithm defined in ZIP 244 [#zip-0244-authcommitment]_ which commits to the authorizing data of a transaction is modified by the OrchardZSA protocol to have the structure specified in this section.
There is a new branch added for issuance information, and the ``orchard_auth_digest`` in ZIP 244 is replaced with ``orchard_zsa_auth_digest`` to account for the presence of Action Groups.

We highlight the changes for the OrchardZSA protocol via the ``[ADDED FOR ZSA]`` text label, and we omit the descriptions of the sections that do not change for the OrchardZSA protocol::

    auth_digest
    ├── transparent_scripts_digest
    ├── sapling_auth_digest
    ├── orchard_zsa_auth_digest     [ADDED FOR ZSA]
    └── issuance_auth_digest        [ADDED FOR ZSA]

The pair (Transaction Identifier, Auth Commitment) constitutes a commitment to all the data of a serialized transaction that may be included in a block.

auth_digest
-----------
A BLAKE2b-256 hash of the following values ::

   A.1: transparent_scripts_digest (32-byte hash output)
   A.2: sapling_auth_digest        (32-byte hash output)
   A.3: orchard_zsa_auth_digest    (32-byte hash output)  [ADDED FOR ZSA]
   A.4: issuance_auth_digest       (32-byte hash output)  [ADDED FOR ZSA]

The personalization field of this hash remains the same as in ZIP 244.


A.3: orchard_zsa_auth_digest
````````````````````````````

In the case that OrchardZSA Action Groups are present, this is a BLAKE2b-256 hash of the following values::

    A.3a: orchard_zsa_action_groups_auth_digest  (32-byte hash output)
    A.3b: bindingSigOrchard                      (field encoding bytes)

The personalization field of this hash is the same as in ZIP 244, that is::

    "ZTxAuthOrchaHash"

In case that the transaction has no OrchardZSA Action Groups, ``orchard_zsa_auth_digest`` is::

    BLAKE2b-256("ZTxAuthOrchaHash", [])

A.3a: orchard_zsa_action_groups_auth_digest
'''''''''''''''''''''''''''''''''''''''''''

This is a BLAKE2b-256 hash of the ``proofsOrchard`` field of all OrchardZSA Action Groups belonging to the transaction; followed by the ``spendAuthSigsOrchard`` fields corresponding to every OrchardZSA Action in the OrchardZSA Action Group, for all OrchardZSA Action Groups belonging to the transaction::

    A.3a.i:  proofsOrchard               (field encoding bytes)
    A.3a.ii: spendAuthSigsOrchard        (field encoding bytes)

The personalization field of this hash is set to::

    "ZTxAuthOrcAGHash"

A.4: issuance_auth_digest
`````````````````````````

The details of the computation of this value are in ZIP 227 [#zip-0227-authcommitment]_.


=========
Rationale
=========

TBD


========================
Reference implementation
========================

TBD


==========
References
==========

.. [#BCP14] `Information on BCP 14 — "RFC 2119: Key words for use in RFCs to Indicate Requirement Levels" and "RFC 8174: Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words" <https://www.rfc-editor.org/info/bcp14>`_
.. [#protocol] `Zcash Protocol Specification, Version 2024.5.1 or later [NU6] <protocol/protocol.pdf>`_
.. [#protocol-spenddesc] `Zcash Protocol Specification, Version 2024.5.1 [NU6]. Section 4.4: Spend Descriptions <protocol/protocol.pdf#spenddesc>`_
.. [#protocol-outputdesc] `Zcash Protocol Specification, Version 2024.5.1 [NU6]. Section 4.5: Output Descriptions <protocol/protocol.pdf#outputdesc>`_
.. [#protocol-actiondesc] `Zcash Protocol Specification, Version 2024.5.1 [NU6]. Section 4.6: Action Descriptions <protocol/protocol.pdf#actiondesc>`_
.. [#protocol-txnencoding] `Zcash Protocol Specification, Version 2022.3.8. Section 7.1: Transaction Encoding and Consensus <protocol/protocol.pdf#txnencoding>`_
.. [#zip-0200] `ZIP 200: Network Upgrade Mechanism <zip-0200.rst>`_
.. [#zip-0244] `ZIP 244: Transaction Identifier Non-Malleability <zip-0244.rst>`_
.. [#zip-0244-sigdigest] `ZIP 244: Transaction Identifier Non-Malleability: Signature Digest <zip-0244.html#signature-digest>`_
.. [#zip-0244-authcommitment] `ZIP 244: Transaction Identifier Non-Malleability: Authorizing Data Commitment <zip-0244.html#authorizing-data-commitment>`_
